<!doctype html>
<html lang="en">
<!--%%HEAD-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" debug_loader="1">
    <link rel="stylesheet" href="../../lib/ESPWebFramework/Resources/css/bootstrap.min.css" debug_loader="1">
    <link rel="stylesheet" href="../css/styles.css" debug_loader="1">
    <link rel="stylesheet" href="../css/dimmer.css" debug_loader="1">
    <link rel="stylesheet" href="../../lib/ESPWebFramework/Resources/css/open-iconic-bootstrap.css" debug_loader="1">
    <title>KFC FW</title>
</head>
<!--HEAD%%-->

<body>
    <!--%%NAV-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">KFC FW</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        </div>
    </nav>
    <!--NAV%%-->
    <div class="container">
        <h1>Dimmer</h1>
        <div id="dimmer-ctrl-container">
            <div class="slidecontainer" id="channel0">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL0_VALUE%" class="slider" id="channel0_slider">
            </div>
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 1-->
            <div class="slidecontainer" id="channel1">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL1_VALUE%" class="slider" id="channel1_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 2-->
            <div class="slidecontainer" id="channel2">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL2_VALUE%" class="slider" id="channel2_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 3-->
            <div class="slidecontainer" id="channel3">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL3_VALUE%" class="slider" id="channel3_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 4-->
            <div class="slidecontainer" id="channel4">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL4_VALUE%" class="slider" id="channel4_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 5-->
            <div class="slidecontainer" id="channel5">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL5_VALUE%" class="slider" id="channel5_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 6-->
            <div class="slidecontainer" id="channel6">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL6_VALUE%" class="slider" id="channel6_slider">
            </div>
            <!--#endif-->
            <!--#if IOT_DIMMER_MODULE_CHANNELS > 7-->
            <div class="slidecontainer" id="channel7">
                <input type="range" min="0" max="%MAX_BRIGHTNESS%" value="%CHANNEL7_VALUE%" class="slider" id="channel7_slider">
            </div>
            <!--#endif-->
        </div>
                                                                
        <!--%%FOOT-->
        <div class="row">
            <div class="col footer">&nbsp;</div>
        </div>
        <!--FOOT%%-->
    </div>
    <!--%%JAVASCRIPT-->
	<script debug_loader="1" type="text/javascript" src="../../lib/ESPWebFramework/Resources/js/jquery-3.3.1.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../../lib/ESPWebFramework/Resources/js/popper.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../../lib/ESPWebFramework/Resources/js/popper.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../../lib/ESPWebFramework/Resources/js/bootstrap.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../../lib/ESPWebFramework/Resources/js/js.cookie.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../js/main.min.js"></script>
	<script debug_loader="1" type="text/javascript" src="../js/debug.js"></script>
    <!--JAVASCRIPT%%-->
    <script>
        $(function() {
            if ($('#dimmer-ctrl-container').length) {
                var webSocket;
                var channels = new Array(8);
                var pending = new Array(8);
                $('.slider').each(function() {
                    var channel = parseInt($(this).attr('id').substr(7, 1));
                    var level = parseInt($(this).val());
                    if (level == 0) {
                        $(this).addClass('slider-off');
                    } else {
                        $(this).removeClass('slider-off');
                    }
                    channels[channel] = level;
                });
                function send_request(channel, level) {
                    // console.log("send_request "+channel+" "+level+" "+pending[channel]);
                    if (pending[channel]) {
                        channels[channel] = level;
                    } else {
                        pending[channel] = true;
                        channels[channel] = level;
                        webSocket.socket.send("+SET " + channel + " " + level);
                        window.setTimeout(function() { // max. update rate 100ms
                            pending[channel] = false;
                            if (channels[channel] != level) {
                                send_request(channel, channels[channel]);
                            }
                        }, 100);
                        // $.get('/dimmer_ctrl/?SID=' + $.getSessionId() + '&channel=' + channel + '&level=' + level + '&id=' + random_str(), function() {
                        //     pending[channel] = false;
                        //     if (channels[channel] != level) {
                        //         send_request(channel, channels[channel]);
                        //     }
                        // });
                    }
                }
                $('.slider').on('input', function() {
                    var channel = parseInt($(this).attr('id').substr(7, 1));
                    var level = parseInt($(this).val());
                    if (level == 0) {
                        $(this).addClass('slider-off');
                    } else {
                        $(this).removeClass('slider-off');
                    }
                    send_request(channel, level);
                });

                function dimmer_data_handler(e) {
                    // console.log("dimmer_data_handler " + e.data);
                    if (e.data.substring(0, 5).toLowerCase() == "+set ") {
                        var arr = e.data.substring(5).split(/ /);
                        var level = parseInt(arr[1]);
                        var slider = $('#channel' + parseInt(arr[0]) + '_slider');
                        if (parseInt(slider.val()) != level) {
                            slider.val(level);
                            if (level == 0) {
                                slider.addClass('slider-off');
                            } else {
                                slider.removeClass('slider-off');
                            }
                        }
                    }
                }

                webSocket = new WS_Console($.getWebSocketLocation('/dimmer_ws'), $.getSessionId(), 10, dimmer_data_handler);
                webSocket.setConsoleId(null);
                webSocket.connect();
            }
        });
    </script>
    
</body>

</html>
